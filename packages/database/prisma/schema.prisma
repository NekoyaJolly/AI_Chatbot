// packages/database/prisma/schema.prisma
// AI Chatbot SaaS - Database Schema
// W1-003: Prisma スキーマ初期定義

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector, pg_trgm, uuidOssp(map: "uuid-ossp")]
}

// ========================================
// User Model
// ========================================
model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String    @unique @db.VarChar(255)
  passwordHash  String?   @map("password_hash") @db.VarChar(255)
  name          String    @db.VarChar(255)
  avatar        String?   @db.VarChar(500)
  authProvider  String    @default("email") @map("auth_provider") @db.VarChar(50)
  emailVerified DateTime? @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  tenants TenantUser[]

  @@index([email])
  @@map("users")
}

// ========================================
// Tenant Model
// ========================================
model Tenant {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name     String  @db.VarChar(255)
  industry String  @db.VarChar(50)
  plan     String  @default("light") @db.VarChar(20)
  status   String  @default("active") @db.VarChar(20)
  settings Json?

  stripeCustomerId     String? @unique @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String? @unique @map("stripe_subscription_id") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users        TenantUser[]
  faqs         TenantFaq[]
  chatSessions ChatSession[]
  templates    TenantTemplate[]

  @@index([industry, status])
  @@map("tenants")
}

// ========================================
// TenantUser (Many-to-Many)
// ========================================
model TenantUser {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId String @map("tenant_id") @db.Uuid
  userId   String @map("user_id") @db.Uuid
  role     String @default("member") @db.VarChar(50)

  invitedAt DateTime @default(now()) @map("invited_at")
  joinedAt  DateTime @default(now()) @map("joined_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId, role])
  @@map("tenant_users")
}

// ========================================
// FaqTemplate (業種別テンプレート)
// ========================================
model FaqTemplate {
  id         String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  industry   String                      @db.VarChar(50)
  question   String                      @db.Text
  answer     String                      @db.Text
  category   String?                     @db.VarChar(100)
  embedding  Unsupported("vector(1536)")? // pgvector型 (Gemini text-embedding-004: 768次元, OpenAI ada-002: 1536次元)
  usageCount Int                         @default(0) @map("usage_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([industry, category])
  @@map("faq_templates")
}

// ========================================
// TenantFaq (テナント個別FAQ)
// ========================================
model TenantFaq {
  id        String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId  String                      @map("tenant_id") @db.Uuid
  question  String                      @db.Text
  answer    String                      @db.Text
  category  String?                     @db.VarChar(100)
  embedding Unsupported("vector(1536)")?
  isActive  Boolean                     @default(true) @map("is_active")

  clickCount    Int @default(0) @map("click_count")
  positiveVotes Int @default(0) @map("positive_votes")
  negativeVotes Int @default(0) @map("negative_votes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
  @@map("tenant_faqs")
}

// ========================================
// ChatSession
// ========================================
model ChatSession {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String  @map("tenant_id") @db.Uuid
  customerId String? @map("customer_id") @db.VarChar(255)
  channel    String  @db.VarChar(20)

  startedAt DateTime  @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  duration  Int?

  csatScore Int?    @map("csat_score") @db.SmallInt
  feedback  String? @db.Text

  isEscalated Boolean   @default(false) @map("is_escalated")
  escalatedAt DateTime? @map("escalated_at")

  tenant   Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([tenantId, startedAt])
  @@index([customerId])
  @@map("chat_sessions")
}

// ========================================
// ChatMessage
// ========================================
model ChatMessage {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId String   @map("session_id") @db.Uuid
  role      String   @db.VarChar(20)
  content   String   @db.Text
  metadata  Json?
  tokens    Int?

  createdAt DateTime @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
  @@map("chat_messages")
}

// ========================================
// TenantTemplate (チャットUI設定)
// ========================================
model TenantTemplate {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId    String  @map("tenant_id") @db.Uuid
  name        String  @db.VarChar(255)
  description String? @db.Text
  config      Json
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
  @@map("tenant_templates")
}
